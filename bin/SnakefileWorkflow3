# get geolevel of the analysis
GERMANY = config["germany"]
TIME = config["time"]
TRENDPLOTS_NAMES = ['deaths_cases', 'deaths_vaccinations', 'deaths_over_cases_vaccinations']
# gen outfile names:
if (GERMANY):
    ALL_OUTPUTS_TRENDPLOTS = expand('../results/trendplot_{trendplots_names}_germany.png', trendplots_names=TRENDPLOTS_NAMES)
    OUTPUT_REGPLOT = '../results/regplot_deaths_over_cases_vaccinations_germany.png'
    ALL_OUTPUTS_CORRTEST = expand('../results/correlationtest_results{significance}_germany.txt', significance =['', '_significance'])
else:
    ALL_OUTPUTS_TRENDPLOTS = expand('../results/trendplot_{trendplots_names}_europe.png', trendplots_names=TRENDPLOTS_NAMES)
    OUTPUT_REGPLOT = '../results/regplot_deaths_over_cases_vaccinations_europe.png'
    ALL_OUTPUTS_CORRTEST = expand('../results/correlationtest_results{significance}_europe.txt', significance =['', '_significance'])


def corrtest_significance(file):
    """Helper function for rule regplot.
    The function reads file, that
    contains either 'True' (= significant correlation hp test results
    and regplot is produced) or 'False', and returns the corresponding boolean value.
    Args:
        file (str): .txt filename
    
    Returns:
        bool.
        """
    with open(file, "r") as file:
        result = file.read()
    if (result == 'True'):
        return True
    else:
        return False


rule clean:
# windows:
    shell: 'del  ..\\results\\*.png ..\\results\\*.txt .\\*.log  ..\\data\\*_processed*.csv'
# linux:
    # shell: 'rm  ..\results\{*.png,*.txt} .\logs\*.log  ..\data\{*_processed*.csv}'


rule all:
    input:
        '../data/owid-covid-data_processed.csv',
        '../data/owid-covid-data_processed_w3.csv',
        ALL_OUTPUTS_CORRTEST,
        OUTPUT_REGPLOT,
        ALL_OUTPUTS_TRENDPLOTS


rule dataprocessing:
    input:
        cmd='dataprocessing.py',
        csv= '../data/owid-covid-data.csv'
    output: '../data/owid-covid-data_processed.csv'
    shell:
        '''
        python {input.cmd} -i {input.csv} -o {output}
        '''


rule dataprocessing_w3:
    input:
        cmd='dataprocessing_w3.py',
        csv='../data/owid-covid-data_processed.csv'
    output: '../data/owid-covid-data_processed_w3.csv'
    shell: 
        '''
        python {input.cmd} -i {input.csv} -o {output} --time {TIME} --germany {GERMANY}
        '''


rule corrtest:
    input:
        cmd='correlationtest_w3.py',
        csv= '../data/owid-covid-data_processed_w3.csv'
    output: ALL_OUTPUTS_CORRTEST
    shell:
        '''
        python {input.cmd} -i {input.csv} -o {output[0]} > {output[1]}
        '''


rule regplot:
    input:
        cmd='regressionplot_w3.py',
        csv= '../data/owid-covid-data_processed_w3.csv',
        correalationtest_res=ALL_OUTPUTS_CORRTEST[1] 
    output: OUTPUT_REGPLOT
    run:
        if corrtest_significance(input.correalationtest_res):
            # proceed with plotting
            shell("python {input.cmd} {input.csv} {output}")
        else:
            # create empty .png
            shell("echo . > {output}")


rule trendplots:
    input:
        cmd='trendplots_w3.py',
        csv='../data/owid-covid-data_processed_w3.csv'
    output: ALL_OUTPUTS_TRENDPLOTS
    shell:
        '''
        python {input.cmd} -i {input.csv} {output} {TIME}
        '''

